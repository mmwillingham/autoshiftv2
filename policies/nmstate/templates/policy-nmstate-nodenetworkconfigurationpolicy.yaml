# This policy creates NodeNetworkConfigurationPolicy resources from labels
# Supports both label-based configuration and legacy file-based configuration
apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  name: policy-nmstate-nncp
  namespace: {{ .Values.policy_namespace }}
  annotations:
    policy.open-cluster-management.io/standards: NIST SP 800-53
    policy.open-cluster-management.io/categories: CM Configuration Management
    policy.open-cluster-management.io/controls: CM-2 Baseline Configuration
spec:
{{ if (($.Values.autoshift).dryRun) }}
  remediationAction: inform
{{ end }}
  dependencies:
    - name: policy-nmstate
      namespace: {{ .Values.policy_namespace }}
      apiVersion: policy.open-cluster-management.io/v1
      compliance: Compliant
      kind: Policy
  disabled: false
  policy-templates:
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: nmstate-operator-nmstate-nncp
        spec:
          remediationAction: enforce
          severity: high
          object-templates-raw: |
            {{ "{{hub-" }} $labels := .ManagedClusterLabels {{ "hub}}" }}
            {{ "{{hub-" }} $hasLabelConfig := false {{ "hub}}" }}
            {{ "{{hub-" }} $idRange := list "1" "2" "3" "4" "5" "6" "7" "8" "9" "10" {{ "hub}}" }}

            {{ "{{hub-" }} $bondIds := list {{ "hub}}" }}
            {{ "{{hub-" }} range $id := $idRange {{ "hub}}" }}
              {{ "{{hub-" }} $bondLabel := printf "autoshift.io/nmstate-bond-%s" $id {{ "hub}}" }}
              {{ "{{hub-" }} if index $labels $bondLabel {{ "hub}}" }}
                {{ "{{hub-" }} $bondIds = append $bondIds $id {{ "hub}}" }}
                {{ "{{hub-" }} $hasLabelConfig = true {{ "hub}}" }}
              {{ "{{hub-" }} end {{ "hub}}" }}
            {{ "{{hub-" }} end {{ "hub}}" }}

            {{ "{{hub-" }} $vlanIds := list {{ "hub}}" }}
            {{ "{{hub-" }} range $id := $idRange {{ "hub}}" }}
              {{ "{{hub-" }} $vlanLabel := printf "autoshift.io/nmstate-vlan-%s" $id {{ "hub}}" }}
              {{ "{{hub-" }} if index $labels $vlanLabel {{ "hub}}" }}
                {{ "{{hub-" }} $vlanIds = append $vlanIds $id {{ "hub}}" }}
                {{ "{{hub-" }} $hasLabelConfig = true {{ "hub}}" }}
              {{ "{{hub-" }} end {{ "hub}}" }}
            {{ "{{hub-" }} end {{ "hub}}" }}

            {{ "{{hub-" }} $ethernetIds := list {{ "hub}}" }}
            {{ "{{hub-" }} range $id := $idRange {{ "hub}}" }}
              {{ "{{hub-" }} $ethLabel := printf "autoshift.io/nmstate-ethernet-%s" $id {{ "hub}}" }}
              {{ "{{hub-" }} if index $labels $ethLabel {{ "hub}}" }}
                {{ "{{hub-" }} $ethernetIds = append $ethernetIds $id {{ "hub}}" }}
                {{ "{{hub-" }} $hasLabelConfig = true {{ "hub}}" }}
              {{ "{{hub-" }} end {{ "hub}}" }}
            {{ "{{hub-" }} end {{ "hub}}" }}

            {{ "{{hub-" }} $ovsBridgeIds := list {{ "hub}}" }}
            {{ "{{hub-" }} range $id := $idRange {{ "hub}}" }}
              {{ "{{hub-" }} $ovsLabel := printf "autoshift.io/nmstate-ovs-bridge-%s" $id {{ "hub}}" }}
              {{ "{{hub-" }} if index $labels $ovsLabel {{ "hub}}" }}
                {{ "{{hub-" }} $ovsBridgeIds = append $ovsBridgeIds $id {{ "hub}}" }}
                {{ "{{hub-" }} $hasLabelConfig = true {{ "hub}}" }}
              {{ "{{hub-" }} end {{ "hub}}" }}
            {{ "{{hub-" }} end {{ "hub}}" }}

            {{ "{{hub-" }} $ovnMappingIds := list {{ "hub}}" }}
            {{ "{{hub-" }} range $id := $idRange {{ "hub}}" }}
              {{ "{{hub-" }} $ovnLabel := printf "autoshift.io/nmstate-ovn-mapping-%s-localnet" $id {{ "hub}}" }}
              {{ "{{hub-" }} if index $labels $ovnLabel {{ "hub}}" }}
                {{ "{{hub-" }} $ovnMappingIds = append $ovnMappingIds $id {{ "hub}}" }}
                {{ "{{hub-" }} $hasLabelConfig = true {{ "hub}}" }}
              {{ "{{hub-" }} end {{ "hub}}" }}
            {{ "{{hub-" }} end {{ "hub}}" }}

            {{ "{{hub-" }} $routeIds := list {{ "hub}}" }}
            {{ "{{hub-" }} range $id := $idRange {{ "hub}}" }}
              {{ "{{hub-" }} $routeLabel := printf "autoshift.io/nmstate-route-%s-dest" $id {{ "hub}}" }}
              {{ "{{hub-" }} if index $labels $routeLabel {{ "hub}}" }}
                {{ "{{hub-" }} $routeIds = append $routeIds $id {{ "hub}}" }}
                {{ "{{hub-" }} $hasLabelConfig = true {{ "hub}}" }}
              {{ "{{hub-" }} end {{ "hub}}" }}
            {{ "{{hub-" }} end {{ "hub}}" }}

            {{ "{{hub-" }} $dnsServerIds := list {{ "hub}}" }}
            {{ "{{hub-" }} range $id := $idRange {{ "hub}}" }}
              {{ "{{hub-" }} $dnsLabel := printf "autoshift.io/nmstate-dns-server-%s" $id {{ "hub}}" }}
              {{ "{{hub-" }} if index $labels $dnsLabel {{ "hub}}" }}
                {{ "{{hub-" }} $dnsServerIds = append $dnsServerIds $id {{ "hub}}" }}
                {{ "{{hub-" }} $hasLabelConfig = true {{ "hub}}" }}
              {{ "{{hub-" }} end {{ "hub}}" }}
            {{ "{{hub-" }} end {{ "hub}}" }}

            {{ "{{hub-" }} $dnsSearchIds := list {{ "hub}}" }}
            {{ "{{hub-" }} range $id := $idRange {{ "hub}}" }}
              {{ "{{hub-" }} $searchLabel := printf "autoshift.io/nmstate-dns-search-%s" $id {{ "hub}}" }}
              {{ "{{hub-" }} if index $labels $searchLabel {{ "hub}}" }}
                {{ "{{hub-" }} $dnsSearchIds = append $dnsSearchIds $id {{ "hub}}" }}
                {{ "{{hub-" }} $hasLabelConfig = true {{ "hub}}" }}
              {{ "{{hub-" }} end {{ "hub}}" }}
            {{ "{{hub-" }} end {{ "hub}}" }}

            {{ "{{hub-" }} $nodeSelectorIds := list {{ "hub}}" }}
            {{ "{{hub-" }} range $id := $idRange {{ "hub}}" }}
              {{ "{{hub-" }} $nsLabel := printf "autoshift.io/nmstate-nodeselector-%s-name" $id {{ "hub}}" }}
              {{ "{{hub-" }} if index $labels $nsLabel {{ "hub}}" }}
                {{ "{{hub-" }} $nodeSelectorIds = append $nodeSelectorIds $id {{ "hub}}" }}
              {{ "{{hub-" }} end {{ "hub}}" }}
            {{ "{{hub-" }} end {{ "hub}}" }}

            {{ "{{hub-" }} if $hasLabelConfig {{ "hub}}" }}
            - complianceType: mustonlyhave
              objectDefinition:
                apiVersion: nmstate.io/v1
                kind: NodeNetworkConfigurationPolicy
                metadata:
                  name: nmstate-label-config
                spec:
                  {{ "{{hub-" }} if gt (len $nodeSelectorIds) 0 {{ "hub}}" }}
                  nodeSelector:
                    {{ "{{hub-" }} range $nsId := $nodeSelectorIds {{ "hub}}" }}
                    {{ "{{hub-" }} $nsPrefix := index $labels (printf "autoshift.io/nmstate-nodeselector-%s-prefix" $nsId) | default "" {{ "hub}}" }}
                    {{ "{{hub-" }} $nsName := index $labels (printf "autoshift.io/nmstate-nodeselector-%s-name" $nsId) {{ "hub}}" }}
                    {{ "{{hub-" }} $nsValue := index $labels (printf "autoshift.io/nmstate-nodeselector-%s-value" $nsId) | default "" {{ "hub}}" }}
                    {{ "{{hub-" }} if $nsPrefix {{ "hub}}" }}
                    {{ "{{hub" }} $nsPrefix {{ "hub}}" }}/{{ "{{hub" }} $nsName {{ "hub}}" }}: '{{ "{{hub" }} $nsValue {{ "hub}}" }}'
                    {{ "{{hub-" }} else {{ "hub}}" }}
                    {{ "{{hub" }} $nsName {{ "hub}}" }}: '{{ "{{hub" }} $nsValue {{ "hub}}" }}'
                    {{ "{{hub-" }} end {{ "hub}}" }}
                    {{ "{{hub-" }} end {{ "hub}}" }}
                  {{ "{{hub-" }} end {{ "hub}}" }}
                  desiredState:
                    interfaces:
                      {{ "{{hub-" }} range $ethId := $ethernetIds {{ "hub}}" }}
                      {{ "{{hub-" }} $ethName := index $labels (printf "autoshift.io/nmstate-ethernet-%s" $ethId) {{ "hub}}" }}
                      {{ "{{hub-" }} $ethState := index $labels (printf "autoshift.io/nmstate-ethernet-%s-state" $ethId) | default "up" {{ "hub}}" }}
                      {{ "{{hub-" }} $ethMac := index $labels (printf "autoshift.io/nmstate-ethernet-%s-mac" $ethId) | default "" {{ "hub}}" }}
                      {{ "{{hub-" }} $ethMtu := index $labels (printf "autoshift.io/nmstate-ethernet-%s-mtu" $ethId) | default "" {{ "hub}}" }}
                      - name: {{ "{{hub" }} $ethName {{ "hub}}" }}
                        type: ethernet
                        state: {{ "{{hub" }} $ethState {{ "hub}}" }}
                        {{ "{{hub-" }} if $ethMac {{ "hub}}" }}
                        mac-address: '{{ "{{hub" }} replace "." ":" $ethMac {{ "hub}}" }}'
                        {{ "{{hub-" }} end {{ "hub}}" }}
                        {{ "{{hub-" }} if $ethMtu {{ "hub}}" }}
                        mtu: {{ "{{hub" }} $ethMtu {{ "hub}}" }}
                        {{ "{{hub-" }} end {{ "hub}}" }}
                      {{ "{{hub-" }} end {{ "hub}}" }}
                      {{ "{{hub-" }} range $bondId := $bondIds {{ "hub}}" }}
                      {{ "{{hub-" }} $bondName := index $labels (printf "autoshift.io/nmstate-bond-%s" $bondId) {{ "hub}}" }}
                      {{ "{{hub-" }} $bondState := index $labels (printf "autoshift.io/nmstate-bond-%s-state" $bondId) | default "up" {{ "hub}}" }}
                      {{ "{{hub-" }} $bondMode := index $labels (printf "autoshift.io/nmstate-bond-%s-mode" $bondId) | default "802.3ad" {{ "hub}}" }}
                      {{ "{{hub-" }} $bondMtu := index $labels (printf "autoshift.io/nmstate-bond-%s-mtu" $bondId) | default "" {{ "hub}}" }}
                      {{ "{{hub-" }} $bondMac := index $labels (printf "autoshift.io/nmstate-bond-%s-mac" $bondId) | default "" {{ "hub}}" }}
                      {{ "{{hub-" }} $bondMiimon := index $labels (printf "autoshift.io/nmstate-bond-%s-miimon" $bondId) | default "" {{ "hub}}" }}
                      {{ "{{hub-" }} $bondIpv4 := index $labels (printf "autoshift.io/nmstate-bond-%s-ipv4" $bondId) | default "disabled" {{ "hub}}" }}
                      {{ "{{hub-" }} $bondIpv6 := index $labels (printf "autoshift.io/nmstate-bond-%s-ipv6" $bondId) | default "disabled" {{ "hub}}" }}

                      {{ "{{hub-" }} $bondPorts := list {{ "hub}}" }}
                      {{ "{{hub-" }} range $portId := $idRange {{ "hub}}" }}
                        {{ "{{hub-" }} $portLabel := printf "autoshift.io/nmstate-bond-%s-port-%s" $bondId $portId {{ "hub}}" }}
                        {{ "{{hub-" }} $portValue := index $labels $portLabel {{ "hub}}" }}
                        {{ "{{hub-" }} if $portValue {{ "hub}}" }}
                          {{ "{{hub-" }} $bondPorts = append $bondPorts $portValue {{ "hub}}" }}
                        {{ "{{hub-" }} end {{ "hub}}" }}
                      {{ "{{hub-" }} end {{ "hub}}" }}

                      {{ "{{hub-" }} $bondIpv4Addrs := list {{ "hub}}" }}
                      {{ "{{hub-" }} range $addrId := $idRange {{ "hub}}" }}
                        {{ "{{hub-" }} $addrLabel := printf "autoshift.io/nmstate-bond-%s-ipv4-address-%s" $bondId $addrId {{ "hub}}" }}
                        {{ "{{hub-" }} $addrValue := index $labels $addrLabel {{ "hub}}" }}
                        {{ "{{hub-" }} if $addrValue {{ "hub}}" }}
                          {{ "{{hub-" }} $cidr := index $labels (printf "autoshift.io/nmstate-bond-%s-ipv4-address-%s-cidr" $bondId $addrId) | default "24" {{ "hub}}" }}
                          {{ "{{hub-" }} $bondIpv4Addrs = append $bondIpv4Addrs (dict "ip" $addrValue "prefix" $cidr) {{ "hub}}" }}
                        {{ "{{hub-" }} end {{ "hub}}" }}
                      {{ "{{hub-" }} end {{ "hub}}" }}

                      {{ "{{hub-" }} $bondIpv6Addrs := list {{ "hub}}" }}
                      {{ "{{hub-" }} range $addrId := $idRange {{ "hub}}" }}
                        {{ "{{hub-" }} $addrLabel := printf "autoshift.io/nmstate-bond-%s-ipv6-address-%s" $bondId $addrId {{ "hub}}" }}
                        {{ "{{hub-" }} $addrValue := index $labels $addrLabel {{ "hub}}" }}
                        {{ "{{hub-" }} if $addrValue {{ "hub}}" }}
                          {{ "{{hub-" }} $cidr := index $labels (printf "autoshift.io/nmstate-bond-%s-ipv6-address-%s-cidr" $bondId $addrId) | default "64" {{ "hub}}" }}
                          {{ "{{hub-" }} $bondIpv6Addrs = append $bondIpv6Addrs (dict "ip" $addrValue "prefix" $cidr) {{ "hub}}" }}
                        {{ "{{hub-" }} end {{ "hub}}" }}
                      {{ "{{hub-" }} end {{ "hub}}" }}

                      - name: {{ "{{hub" }} $bondName {{ "hub}}" }}
                        type: bond
                        state: {{ "{{hub" }} $bondState {{ "hub}}" }}
                        {{ "{{hub-" }} if $bondMac {{ "hub}}" }}
                        mac-address: '{{ "{{hub" }} replace "." ":" $bondMac {{ "hub}}" }}'
                        {{ "{{hub-" }} end {{ "hub}}" }}
                        {{ "{{hub-" }} if $bondMtu {{ "hub}}" }}
                        mtu: {{ "{{hub" }} $bondMtu {{ "hub}}" }}
                        {{ "{{hub-" }} end {{ "hub}}" }}
                        ipv4:
                          {{ "{{hub-" }} if eq $bondIpv4 "disabled" {{ "hub}}" }}
                          enabled: false
                          {{ "{{hub-" }} else if eq $bondIpv4 "dhcp" {{ "hub}}" }}
                          enabled: true
                          dhcp: true
                          {{ "{{hub-" }} else if eq $bondIpv4 "static" {{ "hub}}" }}
                          enabled: true
                          dhcp: false
                          {{ "{{hub-" }} if gt (len $bondIpv4Addrs) 0 {{ "hub}}" }}
                          address:
                            {{ "{{hub-" }} range $addr := $bondIpv4Addrs {{ "hub}}" }}
                            - ip: {{ "{{hub" }} $addr.ip {{ "hub}}" }}
                              prefix-length: {{ "{{hub" }} $addr.prefix {{ "hub}}" }}
                            {{ "{{hub-" }} end {{ "hub}}" }}
                          {{ "{{hub-" }} end {{ "hub}}" }}
                          {{ "{{hub-" }} end {{ "hub}}" }}
                        ipv6:
                          {{ "{{hub-" }} if eq $bondIpv6 "disabled" {{ "hub}}" }}
                          enabled: false
                          {{ "{{hub-" }} else if eq $bondIpv6 "dhcp" {{ "hub}}" }}
                          enabled: true
                          dhcp: true
                          {{ "{{hub-" }} else if eq $bondIpv6 "autoconf" {{ "hub}}" }}
                          enabled: true
                          autoconf: true
                          {{ "{{hub-" }} else if eq $bondIpv6 "static" {{ "hub}}" }}
                          enabled: true
                          dhcp: false
                          autoconf: false
                          {{ "{{hub-" }} if gt (len $bondIpv6Addrs) 0 {{ "hub}}" }}
                          address:
                            {{ "{{hub-" }} range $addr := $bondIpv6Addrs {{ "hub}}" }}
                            - ip: {{ "{{hub" }} $addr.ip {{ "hub}}" }}
                              prefix-length: {{ "{{hub" }} $addr.prefix {{ "hub}}" }}
                            {{ "{{hub-" }} end {{ "hub}}" }}
                          {{ "{{hub-" }} end {{ "hub}}" }}
                          {{ "{{hub-" }} end {{ "hub}}" }}
                        link-aggregation:
                          mode: {{ "{{hub" }} $bondMode {{ "hub}}" }}
                          {{ "{{hub-" }} if $bondMiimon {{ "hub}}" }}
                          options:
                            miimon: {{ "{{hub" }} $bondMiimon {{ "hub}}" }}
                          {{ "{{hub-" }} end {{ "hub}}" }}
                          {{ "{{hub-" }} if gt (len $bondPorts) 0 {{ "hub}}" }}
                          port:
                            {{ "{{hub-" }} range $port := $bondPorts {{ "hub}}" }}
                            - {{ "{{hub" }} $port {{ "hub}}" }}
                            {{ "{{hub-" }} end {{ "hub}}" }}
                          {{ "{{hub-" }} end {{ "hub}}" }}
                      {{ "{{hub-" }} end {{ "hub}}" }}
                      {{ "{{hub-" }} range $vlanId := $vlanIds {{ "hub}}" }}
                      {{ "{{hub-" }} $vlanName := index $labels (printf "autoshift.io/nmstate-vlan-%s" $vlanId) {{ "hub}}" }}
                      {{ "{{hub-" }} $vlanVid := index $labels (printf "autoshift.io/nmstate-vlan-%s-id" $vlanId) {{ "hub}}" }}
                      {{ "{{hub-" }} $vlanBase := index $labels (printf "autoshift.io/nmstate-vlan-%s-base" $vlanId) {{ "hub}}" }}
                      {{ "{{hub-" }} $vlanState := index $labels (printf "autoshift.io/nmstate-vlan-%s-state" $vlanId) | default "up" {{ "hub}}" }}
                      {{ "{{hub-" }} $vlanMtu := index $labels (printf "autoshift.io/nmstate-vlan-%s-mtu" $vlanId) | default "" {{ "hub}}" }}
                      {{ "{{hub-" }} $vlanIpv4 := index $labels (printf "autoshift.io/nmstate-vlan-%s-ipv4" $vlanId) | default "disabled" {{ "hub}}" }}

                      {{ "{{hub-" }} $vlanIpv4Addrs := list {{ "hub}}" }}
                      {{ "{{hub-" }} range $addrId := $idRange {{ "hub}}" }}
                        {{ "{{hub-" }} $addrLabel := printf "autoshift.io/nmstate-vlan-%s-ipv4-address-%s" $vlanId $addrId {{ "hub}}" }}
                        {{ "{{hub-" }} $addrValue := index $labels $addrLabel {{ "hub}}" }}
                        {{ "{{hub-" }} if $addrValue {{ "hub}}" }}
                          {{ "{{hub-" }} $cidr := index $labels (printf "autoshift.io/nmstate-vlan-%s-ipv4-address-%s-cidr" $vlanId $addrId) | default "24" {{ "hub}}" }}
                          {{ "{{hub-" }} $vlanIpv4Addrs = append $vlanIpv4Addrs (dict "ip" $addrValue "prefix" $cidr) {{ "hub}}" }}
                        {{ "{{hub-" }} end {{ "hub}}" }}
                      {{ "{{hub-" }} end {{ "hub}}" }}

                      - name: {{ "{{hub" }} $vlanName {{ "hub}}" }}
                        type: vlan
                        state: {{ "{{hub" }} $vlanState {{ "hub}}" }}
                        {{ "{{hub-" }} if $vlanMtu {{ "hub}}" }}
                        mtu: {{ "{{hub" }} $vlanMtu {{ "hub}}" }}
                        {{ "{{hub-" }} end {{ "hub}}" }}
                        vlan:
                          base-iface: {{ "{{hub" }} $vlanBase {{ "hub}}" }}
                          id: {{ "{{hub" }} $vlanVid {{ "hub}}" }}
                        ipv4:
                          {{ "{{hub-" }} if eq $vlanIpv4 "disabled" {{ "hub}}" }}
                          enabled: false
                          {{ "{{hub-" }} else if eq $vlanIpv4 "dhcp" {{ "hub}}" }}
                          enabled: true
                          dhcp: true
                          {{ "{{hub-" }} else if eq $vlanIpv4 "static" {{ "hub}}" }}
                          enabled: true
                          dhcp: false
                          {{ "{{hub-" }} if gt (len $vlanIpv4Addrs) 0 {{ "hub}}" }}
                          address:
                            {{ "{{hub-" }} range $addr := $vlanIpv4Addrs {{ "hub}}" }}
                            - ip: {{ "{{hub" }} $addr.ip {{ "hub}}" }}
                              prefix-length: {{ "{{hub" }} $addr.prefix {{ "hub}}" }}
                            {{ "{{hub-" }} end {{ "hub}}" }}
                          {{ "{{hub-" }} end {{ "hub}}" }}
                          {{ "{{hub-" }} end {{ "hub}}" }}
                      {{ "{{hub-" }} end {{ "hub}}" }}
                      {{ "{{hub-" }} range $ovsId := $ovsBridgeIds {{ "hub}}" }}
                      {{ "{{hub-" }} $ovsBridgeName := index $labels (printf "autoshift.io/nmstate-ovs-bridge-%s" $ovsId) {{ "hub}}" }}
                      {{ "{{hub-" }} $ovsStp := index $labels (printf "autoshift.io/nmstate-ovs-bridge-%s-stp" $ovsId) | default "false" {{ "hub}}" }}
                      {{ "{{hub-" }} $ovsAllowExtraPatch := index $labels (printf "autoshift.io/nmstate-ovs-bridge-%s-allow-extra-patch-ports" $ovsId) | default "true" {{ "hub}}" }}
                      {{ "{{hub-" }} $ovsMcastSnooping := index $labels (printf "autoshift.io/nmstate-ovs-bridge-%s-mcast-snooping" $ovsId) | default "" {{ "hub}}" }}

                      {{ "{{hub-" }} $ovsBridgePorts := list {{ "hub}}" }}
                      {{ "{{hub-" }} range $portId := $idRange {{ "hub}}" }}
                        {{ "{{hub-" }} $portLabel := printf "autoshift.io/nmstate-ovs-bridge-%s-port-%s" $ovsId $portId {{ "hub}}" }}
                        {{ "{{hub-" }} $portValue := index $labels $portLabel {{ "hub}}" }}
                        {{ "{{hub-" }} if $portValue {{ "hub}}" }}
                          {{ "{{hub-" }} $ovsBridgePorts = append $ovsBridgePorts $portValue {{ "hub}}" }}
                        {{ "{{hub-" }} end {{ "hub}}" }}
                      {{ "{{hub-" }} end {{ "hub}}" }}

                      - name: {{ "{{hub" }} $ovsBridgeName {{ "hub}}" }}
                        type: ovs-bridge
                        state: up
                        bridge:
                          allow-extra-patch-ports: {{ "{{hub" }} $ovsAllowExtraPatch {{ "hub}}" }}
                          options:
                            stp: {{ "{{hub" }} $ovsStp {{ "hub}}" }}
                            {{ "{{hub-" }} if $ovsMcastSnooping {{ "hub}}" }}
                            mcast-snooping-enable: {{ "{{hub" }} $ovsMcastSnooping {{ "hub}}" }}
                            {{ "{{hub-" }} end {{ "hub}}" }}
                          {{ "{{hub-" }} if gt (len $ovsBridgePorts) 0 {{ "hub}}" }}
                          port:
                            {{ "{{hub-" }} range $port := $ovsBridgePorts {{ "hub}}" }}
                            - name: {{ "{{hub" }} $port {{ "hub}}" }}
                            {{ "{{hub-" }} end {{ "hub}}" }}
                          {{ "{{hub-" }} end {{ "hub}}" }}
                      {{ "{{hub-" }} end {{ "hub}}" }}
                    {{ "{{hub-" }} if gt (len $routeIds) 0 {{ "hub}}" }}
                    routes:
                      config:
                        {{ "{{hub-" }} range $routeId := $routeIds {{ "hub}}" }}
                        {{ "{{hub-" }} $routeDest := index $labels (printf "autoshift.io/nmstate-route-%s-dest" $routeId) {{ "hub}}" }}
                        {{ "{{hub-" }} $routeCidr := index $labels (printf "autoshift.io/nmstate-route-%s-cidr" $routeId) {{ "hub}}" }}
                        {{ "{{hub-" }} $routeGw := index $labels (printf "autoshift.io/nmstate-route-%s-gateway" $routeId) {{ "hub}}" }}
                        {{ "{{hub-" }} $routeIface := index $labels (printf "autoshift.io/nmstate-route-%s-interface" $routeId) {{ "hub}}" }}
                        {{ "{{hub-" }} $routeMetric := index $labels (printf "autoshift.io/nmstate-route-%s-metric" $routeId) | default "" {{ "hub}}" }}
                        {{ "{{hub-" }} $routeTable := index $labels (printf "autoshift.io/nmstate-route-%s-table" $routeId) | default "" {{ "hub}}" }}
                        - destination: {{ "{{hub" }} $routeDest {{ "hub}}" }}/{{ "{{hub" }} $routeCidr {{ "hub}}" }}
                          next-hop-address: {{ "{{hub" }} $routeGw {{ "hub}}" }}
                          next-hop-interface: {{ "{{hub" }} $routeIface {{ "hub}}" }}
                          {{ "{{hub-" }} if $routeMetric {{ "hub}}" }}
                          metric: {{ "{{hub" }} $routeMetric {{ "hub}}" }}
                          {{ "{{hub-" }} end {{ "hub}}" }}
                          {{ "{{hub-" }} if $routeTable {{ "hub}}" }}
                          table-id: {{ "{{hub" }} $routeTable {{ "hub}}" }}
                          {{ "{{hub-" }} end {{ "hub}}" }}
                        {{ "{{hub-" }} end {{ "hub}}" }}
                    {{ "{{hub-" }} end {{ "hub}}" }}

                    {{ "{{hub-" }} if or (gt (len $dnsServerIds) 0) (gt (len $dnsSearchIds) 0) {{ "hub}}" }}
                    dns-resolver:
                      config:
                        {{ "{{hub-" }} if gt (len $dnsServerIds) 0 {{ "hub}}" }}
                        server:
                          {{ "{{hub-" }} range $dnsId := $dnsServerIds {{ "hub}}" }}
                          {{ "{{hub-" }} $server := index $labels (printf "autoshift.io/nmstate-dns-server-%s" $dnsId) {{ "hub}}" }}
                          - {{ "{{hub" }} $server {{ "hub}}" }}
                          {{ "{{hub-" }} end {{ "hub}}" }}
                        {{ "{{hub-" }} end {{ "hub}}" }}
                        {{ "{{hub-" }} if gt (len $dnsSearchIds) 0 {{ "hub}}" }}
                        search:
                          {{ "{{hub-" }} range $searchId := $dnsSearchIds {{ "hub}}" }}
                          {{ "{{hub-" }} $domain := index $labels (printf "autoshift.io/nmstate-dns-search-%s" $searchId) {{ "hub}}" }}
                          - {{ "{{hub" }} $domain {{ "hub}}" }}
                          {{ "{{hub-" }} end {{ "hub}}" }}
                        {{ "{{hub-" }} end {{ "hub}}" }}
                    {{ "{{hub-" }} end {{ "hub}}" }}

                    {{ "{{hub-" }} if gt (len $ovnMappingIds) 0 {{ "hub}}" }}
                    ovn:
                      bridge-mappings:
                        {{ "{{hub-" }} range $mappingId := $ovnMappingIds {{ "hub}}" }}
                        {{ "{{hub-" }} $localnetName := index $labels (printf "autoshift.io/nmstate-ovn-mapping-%s-localnet" $mappingId) {{ "hub}}" }}
                        {{ "{{hub-" }} $bridgeName := index $labels (printf "autoshift.io/nmstate-ovn-mapping-%s-bridge" $mappingId) {{ "hub}}" }}
                        - localnet: {{ "{{hub" }} $localnetName {{ "hub}}" }}
                          bridge: {{ "{{hub" }} $bridgeName {{ "hub}}" }}
                          state: present
                        {{ "{{hub-" }} end {{ "hub}}" }}
                    {{ "{{hub-" }} end {{ "hub}}" }}
            {{ "{{hub-" }} end {{ "hub}}" }}

            {{ "{{hub-" }} $nncp_list := list {{ "hub}}" }}
            {{ "{{hub-" }} range $label, $labelvalue := .ManagedClusterLabels {{ "hub}}" }}
              {{ "{{hub-" }} if $label | hasPrefix "autoshift.io/nmstate-nncp" {{ "hub}}" }}
                {{ "{{hub-" }} $nncp_list = append $nncp_list $labelvalue {{ "hub}}" }}
              {{ "{{hub-" }} end {{ "hub}}" }}
            {{ "{{hub-" }} end {{ "hub}}" }}
            {{ "{{hub-" }} if not (eq 0 (len $nncp_list)) {{ "hub}}" }}
              {{ "{{hub-" }} range $nncp_list {{ "hub}}" }}
                {{ "{{hub-" }} $configmap := ((lookup "v1" "ConfigMap" "{{ $.Values.policy_namespace }}" (print "nmstate-" .)).data) {{ "hub}}" }}
            - complianceType: mustonlyhave
              objectDefinition:
                apiVersion: nmstate.io/v1
                kind: NodeNetworkConfigurationPolicy
                metadata:
                  name: nmstate-{{ "{{hub"}} . {{ "hub}}" }}
                spec:
                  {{ "{{hub-" }} if $configmap.nodeSelector {{ "hub}}" }}
                  nodeSelector:
                    {{ "{{hub" }} $configmap.nodeSelector | base64dec | autoindent {{ "hub}}" }}
                  {{ "{{hub-" }} end {{ "hub}}" }}
                  desiredState:
                    {{ "{{hub" }}$configmap.nmstate | base64dec | autoindent {{ "hub}}" }}
              {{ "{{hub-"}} end {{ "hub}}" }}
            {{ "{{hub-"}} end {{ "hub}}" }}
---
apiVersion: cluster.open-cluster-management.io/v1beta1
kind: Placement
metadata:
  name: placement-policy-nmstate-nncp
  namespace: {{ .Values.policy_namespace }}
spec:
  clusterSets:
  {{- range $clusterSet, $value := $.Values.managedClusterSets }}
    - {{ $clusterSet }}
  {{- end }}
  {{- range $clusterSet, $value := $.Values.hubClusterSets }}
    - {{ $clusterSet }}
  {{- end }}
  predicates:
    - requiredClusterSelector:
        labelSelector:
          matchExpressions:
            - key: 'autoshift.io/nmstate'
              operator: In
              values:
              - 'true'
  tolerations:
    - key: cluster.open-cluster-management.io/unreachable
      operator: Exists
    - key: cluster.open-cluster-management.io/unavailable
      operator: Exists
---
apiVersion: policy.open-cluster-management.io/v1
kind: PlacementBinding
metadata:
  name: placement-policy-nmstate-nncp
  namespace: {{ .Values.policy_namespace }}
placementRef:
  name: placement-policy-nmstate-nncp
  apiGroup: cluster.open-cluster-management.io
  kind: Placement
subjects:
  - name: policy-nmstate-nncp
    apiGroup: policy.open-cluster-management.io
    kind: Policy
